<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Biblioteca Arco-Íris - Meus Empréstimos</title>
  <link rel="icon" href="favicon.ico">
  <link rel="stylesheet" href="CSS/emprestimo.css">
  <style>
    .emprestimos-container {
      max-width: 1200px;
      margin: 80px auto 20px;
      padding: 20px;
    }

    .emprestimo-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      gap: 20px;
      align-items: center;
      opacity: 0;
      transform: translateY(20px);
      animation: fadeInUp 0.5s ease forwards;
    }

    @keyframes fadeInUp {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .emprestimo-card.atrasado {
      border: 2px solid #f44336;
    }

    .book-image {
      width: 120px;
      height: 180px;
      object-fit: cover;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      background-color: #f5f5f5;
    }

    .emprestimo-info {
      flex: 1;
    }

    .emprestimo-actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: flex-end;
    }

    .emprestimo-info h3 {
      margin: 0 0 10px 0;
      color: #333;
      font-size: 18px;
    }

    .emprestimo-info p {
      margin: 5px 0;
      color: #666;
    }

    .status {
      font-weight: bold;
    }

    .multa {
      color: #f44336 !important;
      font-weight: bold;
    }

    .devolver-btn {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .devolver-btn:hover {
      background: #388E3C;
      transform: translateY(-2px);
    }

    .devolver-btn.pendente {
      background: #d17400;
      cursor: not-allowed;
      opacity: 0.8;
    }

    .devolver-btn.pendente:hover {
      transform: none;
      background: #d17400;
    }

    .pagar-multa-btn {
      background: #f44336;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s ease;
      margin-top: 10px;
      width: 100%;
    }

    .pagar-multa-btn:hover {
      background: #d32f2f;
      transform: translateY(-2px);
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      background: #f9f9f9;
      border-radius: 12px;
      margin-top: 20px;
    }

    .empty-state h2 {
      color: #666;
      margin-bottom: 20px;
    }

    .header-btn {
      background: #ff9000;
      color: white;
      text-decoration: none;
      padding: 10px 20px;
      border-radius: 6px;
      transition: all 0.3s ease;
    }

    .header-btn:hover {
      background: #e67e00;
      transform: translateY(-2px);
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-title">
      <img src="./IMG/logo.png" alt="Logo" style="height: 30px;">
      <span>Biblioteca Arco-Íris</span>
    </div>
    <div class="header-buttons">
      <div class="user-info">
        <span id="userName" class="user-name">Bem-vindo(a)!</span>
        <a href="usuario.html" class="header-btn">Voltar</a>
        <a href="index.html" class="header-btn">Sair</a>
      </div>
    </div>
  </header>

  <!-- Modal de Pagamento -->
  <div id="paymentModal" class="modal">
    <div class="modal-content">
      <span class="close-modal">&times;</span>
      <h2 class="modal-title">Escolha a forma de pagamento</h2>
      <div class="payment-options">
        <div class="payment-option" data-method="pix">
          <img src="IMG/pix.png" alt="PIX">
          <div>PIX</div>
        </div>
        <div class="payment-option" data-method="card">
          <img src="IMG/card.png" alt="Cartão">
          <div>Cartão</div>
        </div>
        <div class="payment-option" data-method="boleto">
          <img src="IMG/boleto.png" alt="Boleto">
          <div>Boleto</div>
        </div>
        <div class="payment-option" data-method="doacao" style="display: none;">
          <img src="IMG/doacao.png" alt="Doação">
          <div>Doar Item Higiênico</div>
        </div>
      </div>
      <button class="btn-confirmar">Confirmar</button>
    </div>
  </div>

  <div class="container">
    <div class="emprestimos-container">
      <div id="emprestimosList">
        <!-- Os empréstimos serão inseridos aqui via JavaScript -->
      </div>
      <!-- Exemplo de estado vazio -->
      <div class="empty-state" style="display: none;">
        <h2>Você não tem empréstimos ativos</h2>
        <a href="usuario.html" class="header-btn">Emprestar um livro</a>
      </div>
    </div>
  </div>

  <script>
    // Verificar se o usuário está logado
    window.addEventListener('load', function() {
      const usuarioLogado = JSON.parse(localStorage.getItem('usuarioLogado'));
      if (!usuarioLogado) {
        window.location.href = 'login.html';
        return;
      }

      // Carregar empréstimos do usuário
      const users = JSON.parse(localStorage.getItem('users')) || [];
      const user = users.find(u => u.id === usuarioLogado.id);
      
      if (user) {
        // Atualizar mensagem de boas-vindas
        document.getElementById('userName').textContent = 'Bem-vindo(a)!';

        const emprestimosDiv = document.getElementById('emprestimosList');
        const emprestimos = user.loans || [];

        if (emprestimos.length === 0) {
          document.querySelector('.empty-state').style.display = 'block';
          emprestimosDiv.style.display = 'none';
        } else {
          document.querySelector('.empty-state').style.display = 'none';
          emprestimosDiv.style.display = 'block';

          // Ordenar empréstimos: atrasados primeiro, depois por data de empréstimo
          const emprestimosOrdenados = emprestimos.sort((a, b) => {
            if (a.status === 'atrasado' && b.status !== 'atrasado') return -1;
            if (a.status !== 'atrasado' && b.status === 'atrasado') return 1;
            return new Date(b.loanDate) - new Date(a.loanDate);
          });
          
          emprestimosDiv.innerHTML = emprestimosOrdenados.map((emprestimo, index) => {
            // Verificar se o empréstimo está atrasado
            const hoje = new Date();
            const dataDevolucao = new Date(emprestimo.dueDate);
            if (!emprestimo.returned && dataDevolucao < hoje && emprestimo.status !== 'pendente_devolucao') {
              emprestimo.status = 'atrasado';
              // Calcular multa (R$ 1 por dia de atraso, máximo de R$ 5)
              const diasAtraso = Math.floor((hoje - dataDevolucao) / (1000 * 60 * 60 * 24));
              emprestimo.debtAmount = Math.min(diasAtraso * 1, 5);
            }

            const bookImage = emprestimo.bookImage || emprestimo.imagem;
            
            return `
              <div class="emprestimo-card ${emprestimo.status === 'atrasado' ? 'atrasado' : ''}" 
                   style="animation-delay: ${index * 0.1}s">
                <img src="${bookImage}" 
                     alt="${emprestimo.bookTitle || emprestimo.titulo}" 
                     class="book-image">
                <div class="emprestimo-info">
                  <h3>${emprestimo.bookTitle || emprestimo.titulo}</h3>
                  <p>Data do Empréstimo: ${formatDate(emprestimo.loanDate)}</p>
                  <p>Data de Devolução: ${formatDate(emprestimo.dueDate)}</p>
                  <p class="status">Status: ${getStatusText(emprestimo)}</p>
                  ${emprestimo.status === 'atrasado' ? 
                    `<p class="multa">Multa: R$ ${emprestimo.debtAmount.toFixed(2)}</p>` : ''}
                </div>
                ${!emprestimo.returned ? `
                  <div class="emprestimo-actions">
                    ${emprestimo.status !== 'atrasado' ? `
                      <button class="devolver-btn ${emprestimo.status === 'pendente_devolucao' ? 'pendente' : ''}" 
                              onclick="solicitarDevolucao(${emprestimo.id})"
                              ${emprestimo.status === 'pendente_devolucao' ? 'disabled' : ''}>
                        ${emprestimo.status === 'pendente_devolucao' ? 'Devolução Solicitada' : 'Solicitar Devolução'}
                      </button>
                    ` : ''}
                    ${emprestimo.status === 'atrasado' ? `
                      <button class="pagar-multa-btn" onclick="abrirModalPagamento(${emprestimo.id})">
                        ${emprestimo.debtAmount >= 5 ? 'Pagar Multa ou Doar Item Higiênico' : 'Pagar Multa'}
                      </button>
                    ` : ''}
                  </div>
                ` : ''}
              </div>
            `;
          }).join('');

          // Salvar as alterações se houve atualização de status ou multas
          if (emprestimos.some(e => e.status === 'atrasado')) {
            const userIndex = users.findIndex(u => u.id === user.id);
            if (userIndex !== -1) {
              users[userIndex] = user;
              localStorage.setItem('users', JSON.stringify(users));
              localStorage.setItem('usuarioLogado', JSON.stringify(user));
            }
          }
        }
      }
    });

    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('pt-BR');
    }

    function getStatusText(emprestimo) {
      if (emprestimo.returned) return 'Devolvido';
      if (emprestimo.status === 'atrasado') return 'Atrasado';
      if (emprestimo.status === 'pendente_devolucao') return 'Devolução Pendente';
      return 'Em Andamento';
    }

    function solicitarDevolucao(emprestimoId) {
      const usuarioLogado = JSON.parse(localStorage.getItem('usuarioLogado'));
      const users = JSON.parse(localStorage.getItem('users')) || [];
      const user = users.find(u => u.id === usuarioLogado.id);
      
      if (user) {
        const emprestimo = user.loans.find(l => l.id === emprestimoId);
        if (emprestimo) {
          // Criar solicitação de devolução
          const solicitacao = {
            id: Date.now(),
            userId: user.id,
            usuario: {
              nome: user.nome,
              cpf: user.cpf,
              telefone: user.telefone
            },
            titulo: emprestimo.bookTitle || emprestimo.titulo,
            imagem: emprestimo.bookImage || emprestimo.imagem,
            emprestimoId: emprestimo.id,
            dataEmprestimo: emprestimo.loanDate,
            dataDevolucao: emprestimo.dueDate,
            status: 'pendente'
          };

          // Salvar solicitação
          const solicitacoes = JSON.parse(localStorage.getItem('solicitacoesDevolucao') || '[]');
          solicitacoes.push(solicitacao);
          localStorage.setItem('solicitacoesDevolucao', JSON.stringify(solicitacoes));

          // Atualizar status do empréstimo
          emprestimo.status = 'pendente_devolucao';
          
          // Atualizar usuário no localStorage
          const userIndex = users.findIndex(u => u.id === user.id);
          if (userIndex !== -1) {
            users[userIndex] = user;
            localStorage.setItem('users', JSON.stringify(users));
            localStorage.setItem('usuarioLogado', JSON.stringify(user));
          }

          alert('Solicitação de devolução enviada com sucesso!');
          location.reload();
        }
      }
    }

    // Função para abrir o modal de pagamento
    function abrirModalPagamento(emprestimoId) {
      const usuarioLogado = JSON.parse(localStorage.getItem('usuarioLogado'));
      const users = JSON.parse(localStorage.getItem('users')) || [];
      const user = users.find(u => u.id === usuarioLogado.id);
      
      if (user) {
        const emprestimo = user.loans.find(l => l.id === emprestimoId);
        if (emprestimo && emprestimo.debtAmount) {
          // Mostrar ou esconder a opção de doação baseado no valor da multa
          const doacaoOption = document.querySelector('.payment-option[data-method="doacao"]');
          if (doacaoOption) {
            doacaoOption.style.display = emprestimo.debtAmount >= 5 ? 'block' : 'none';
          }
          
          // Limpar seleção anterior
          document.querySelectorAll('.payment-option').forEach(option => {
            option.classList.remove('selected');
          });
          
          // Mostrar o modal
          document.getElementById('paymentModal').style.display = 'block';
          
          // Configurar o botão de confirmar
          document.querySelector('.btn-confirmar').onclick = function() {
            const selectedMethod = document.querySelector('.payment-option.selected');
            if (!selectedMethod) {
              alert('Por favor, selecione um método de pagamento ou doação.');
              return;
            }

            const method = selectedMethod.dataset.method;
            
            if (method === 'doacao' && emprestimo.debtAmount >= 5) {
              // Processar a doação
              emprestimo.debtAmount = 0;
              emprestimo.status = 'emprestado';
              
              // Registrar a doação
              const doacao = {
                id: Date.now(),
                userId: user.id,
                usuario: {
                  nome: user.nome,
                  cpf: user.cpf
                },
                tipo: 'higienico',
                data: new Date().toISOString(),
                status: 'pendente'
              };
              
              const doacoes = JSON.parse(localStorage.getItem('pendingDonations') || '[]');
              doacoes.push(doacao);
              localStorage.setItem('pendingDonations', JSON.stringify(doacoes));
            } else {
              // Processar o pagamento normal
              emprestimo.debtAmount = 0;
              emprestimo.status = 'emprestado';
            }
            
            localStorage.setItem('users', JSON.stringify(users));
            document.getElementById('paymentModal').style.display = 'none';
            alert(method === 'doacao' ? 'Doação registrada com sucesso! Traga seu item higiênico na próxima visita.' : 'Pagamento realizado com sucesso!');
            location.reload();
          };
        }
      }
    }

    // Adicionar eventos aos métodos de pagamento
    document.querySelectorAll('.payment-option').forEach(option => {
      option.addEventListener('click', function() {
        document.querySelectorAll('.payment-option').forEach(opt => {
          opt.classList.remove('selected');
        });
        this.classList.add('selected');
      });
    });

    // Fechar modal de pagamento
    document.querySelector('.close-modal').addEventListener('click', function() {
      document.getElementById('paymentModal').style.display = 'none';
    });

    window.addEventListener('click', function(event) {
      const modal = document.getElementById('paymentModal');
      if (event.target === modal) {
        modal.style.display = 'none';
      }
    });

    // Função para fazer logout
    document.querySelector('a[href="index.html"]').addEventListener('click', function(e) {
      e.preventDefault();
      localStorage.removeItem('usuarioLogado');
      window.location.href = 'index.html';
    });

    function confirmarPagamento() {
      const emprestimoId = parseInt(document.getElementById('currentEmprestimoId').value);
      const usuarioLogado = JSON.parse(localStorage.getItem('usuarioLogado'));
      const users = JSON.parse(localStorage.getItem('users')) || [];
      const user = users.find(u => u.id === usuarioLogado.id);
      
      if (user) {
        const emprestimo = user.loans.find(l => l.id === emprestimoId);
        if (emprestimo) {
          // Marcar o empréstimo como devolvido e pago
          emprestimo.returned = true;
          emprestimo.status = 'devolvido';
          emprestimo.debtAmount = 0;

          // Atualizar o livro no estoque
          const livros = JSON.parse(localStorage.getItem('livros') || '[]');
          const livro = livros.find(l => l.title === emprestimo.bookTitle);
          if (livro) {
            livro.estoque++;
            localStorage.setItem('livros', JSON.stringify(livros));
          }

          // Atualizar a lista geral de empréstimos
          const emprestimos = JSON.parse(localStorage.getItem('emprestimos') || '[]');
          const emprestimoIndex = emprestimos.findIndex(e => e.id === emprestimoId);
          if (emprestimoIndex !== -1) {
            emprestimos[emprestimoIndex] = emprestimo;
            localStorage.setItem('emprestimos', JSON.stringify(emprestimos));
          }

          // Atualizar o usuário
          const userIndex = users.findIndex(u => u.id === user.id);
          if (userIndex !== -1) {
            users[userIndex] = user;
            localStorage.setItem('users', JSON.stringify(users));
          }

          // Atualizar usuário logado
          localStorage.setItem('usuarioLogado', JSON.stringify(user));

          // Fechar o modal
          document.getElementById('paymentModal').style.display = 'none';
          
          // Recarregar a página para atualizar a lista de empréstimos
          window.location.reload();
        }
      }
    }
  </script>
</body>
</html> 